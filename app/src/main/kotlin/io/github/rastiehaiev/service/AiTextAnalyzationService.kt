package io.github.rastiehaiev.service

import io.github.rastiehaiev.client.OpenAiClient
import org.slf4j.LoggerFactory

class AiTextAnalyzationService(private val client: OpenAiClient) {
    private val logger = LoggerFactory.getLogger(javaClass)

    fun analyze(userInput: String) =
        client.ask(PROMPT, userInput)
            .onFailure { logger.error("Error while asking user input $userInput", it) }
            .getOrNull()
            ?.toUserInputAnalyzed()

    private fun String.toUserInputAnalyzed(): UserInputAnalyzed? {
        val regex = Regex("""^::(\w[\w-]*)::\s*$""", RegexOption.MULTILINE)
        val fieldsMap = mutableMapOf<String, String>()
        val lines = this.lines()
        val buffer = mutableListOf<String>()

        var currentKey: String? = null
        for (line in lines) {
            val match = regex.matchEntire(line)
            if (match != null) {
                // Save previous key-value pair
                currentKey?.let { key ->
                    fieldsMap[key] = buffer.joinToString("\n").trim()
                    buffer.clear()
                }
                currentKey = match.groupValues[1].lowercase()
            } else {
                buffer.add(line)
            }
        }

        // Save the last block
        currentKey?.let { key -> fieldsMap[key] = buffer.joinToString("\n").trim() }

        if (fieldsMap.isEmpty()) {
            return null
        }

        val wordsMap = fieldsMap["words"]
            ?.lineSequence()
            ?.mapNotNull {
                val (k, v) = it.split("-", limit = 2).map(String::trim)
                if (k.isNotEmpty() && v.isNotEmpty()) k to v else null
            }
            ?.toMap()

        return UserInputAnalyzed(
            corrected = fieldsMap["corrected"],
            explanation = fieldsMap["explanation"],
            alternative = fieldsMap["alternative"],
            translationUa = fieldsMap["translation-ua"],
            translationIt = fieldsMap["translation-it"],
            words = wordsMap,
        )
    }
}

data class UserInputAnalyzed(
    val corrected: String?,
    val explanation: String?,
    val alternative: String?,
    val translationUa: String?,
    val translationIt: String?,
    val words: Map<String, String>?,
)

private const val PROMPT = """
–¢–∏ —á–∞—Ç-–±–æ—Ç, —è–∫–∏–π –¥–æ–ø–æ–º–∞–≥–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ –≤–∏–≤—á–∞—Ç–∏ —ñ—Ç–∞–ª—ñ–π—Å—å–∫—É –º–æ–≤—É. 

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–æ–±—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
- —ñ—Ç–∞–ª—ñ–π—Å—å–∫–æ—é - –≤ —Ç–∞–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É —Ç–∏ –º—É—Å–∏—à –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –π–æ–≥–æ –Ω–∞ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å;
- —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é - –≤ —Ç–∞–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É —Ç–∏ –º—É—Å–∏—à –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ —Ä–µ—á–µ–Ω–Ω—è —ñ—Ç–∞–ª—ñ–π—Å—å–∫–æ—é - –±—ñ–ª—å—à–µ –Ω—ñ—á–æ–≥–æ.
- –º—ñ–∫—Å–æ–º —ñ—Ç–∞–ª—ñ–π—Å—å–∫–æ—ó —ñ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –º–æ–≤ - –≤ —Ç–∞–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É —Ç–∏ –º—É—Å–∏—à –ø–µ—Ä–µ–∫–ª–∞—Å—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—ñ —Å–ª–æ–≤–∞ —ñ —Ñ—Ä–∞–∑–∏ —ñ—Ç–∞–ª—ñ–π—Å—å–∫–æ—é —ñ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ—á–µ–Ω–Ω—è –Ω–∞ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å.

–ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å:
- –ø–µ—Ä–µ–≤—ñ—Ä—è–π –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—á–Ω—ñ, –≥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —ñ –º–æ—Ä—Ñ–æ–ª–æ–≥—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏;
- —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—è —ñ—Ç–∞–ª—ñ–π—Å—å–∫–∞ —Ä–æ–∑–∫–ª–∞–¥–∫–∞ –Ω–∞ –∫–æ–º–ø º—é—Ç–µ—Ä—ñ; –≤ —Ç–∞–∫–æ–º—É —Ä–∞–∑—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –∑–∞–º—ñ—Å—Ç—å –Ω–∞–≥–æ–ª–æ—Å—É –≤ —Å–ª–æ–≤—ñ —Å—Ç–∞–≤–∏—Ç–∏ —Å–∏–º–≤–æ–ª "'" - –Ω–µ —Ä–æ–∑–≥–ª—è–¥–∞–π —Ü–µ —è–∫ –ø–æ–º–∏–ª–∫—É. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–º—ñ—Å—Ç—å "ci√≤", –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –≤–≤–µ—Å—Ç–∏ "cio'" - —Ü–µ –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç!

–í –∫—ñ–Ω—Ü—ñ —Å–≤–æ—î—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞–¥–∞–π —Å–ø–∏—Å–æ–∫ —Å–ª—ñ–≤/—Ñ—Ä–∞–∑, –≤ —è–∫–∏—Ö –±—É–ª–æ –¥–æ–ø—É—â–µ–Ω–æ –ø–æ–º–∏–ª–∫–∏. –§–æ—Ä–º–∞—Ç –º–∞—î –±—É—Ç–∏ —Ç–∞–∫–∏–º:
<—ñ—Ç–∞–ª—ñ–π—Å—å–∫–µ —Å–ª–æ–≤–æ> - <—É–∫—Ä–∞—ó–Ω—Å—å–∫–µ —Å–ª–æ–≤–æ>
<—ñ—Ç–∞–ª—ñ–π—Å—å–∫–µ —Å–ª–æ–≤–æ> - <—É–∫—Ä–∞—ó–Ω—Å—å–∫–µ —Å–ª–æ–≤–æ>

–§–æ—Ä–º–∞—Ç —Ç–≤–æ—î—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–∞—î –±—É—Ç–∏ —Ç–∞–∫–∏–º:
::corrected::
<>
::explanation::
<>
::alternative::
<>
::translation-ua::
<>
::translation-it::
<>
::words::
<>

–ü—Ä–∞–≤–∏–ª–∞ —â–æ–¥–æ –∫–æ–∂–Ω–æ–≥–æ –±–ª–æ–∫—É —Ç–≤–æ—î—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
::corrected::
- –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–µ —Ä–µ—á–µ–Ω–Ω—è
- –≤–∏–¥—ñ–ª–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Å–ª–æ–≤–∞ —ñ —Ñ—Ä–∞–∑–∏ –∑—ñ—Ä–æ—á–∫–∞–º–∏ (*)
- —è–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–ª–æ –ø–æ–≤–Ω—ñ—Å—Ç—é —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!

::explanation::
- –∫–æ—Ä–æ—Ç–∫–æ –∞–ª–µ –ø–æ —Å—É—Ç—ñ –ø–æ—è—Å–Ω–∏, –≤ —á–æ–º—É –±—É–ª–∏ –ø–æ–º–∏–ª–∫–∏
- —è–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–ª–æ –ø–æ–≤–Ω—ñ—Å—Ç—é —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!

::alternative::
- –¥–æ–¥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É, —è–∫ —Ü–µ–π —Ç–µ–∫—Å—Ç –º–æ–∂–Ω–∞ –±—É–ª–æ –± —ñ–Ω–∞–∫—à–µ –Ω–∞–ø–∏—Å–∞—Ç–∏. –Ø–∫—â–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ - –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!
- —è–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–ª–æ –ø–æ–≤–Ω—ñ—Å—Ç—é —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!

::translation-ua::
- –ø–µ—Ä–µ–∫–ª–∞–¥–∏ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É
- —è–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–ª–æ –ø–æ–≤–Ω—ñ—Å—Ç—é —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!

::translation-it::
- –ø–µ—Ä–µ–∫–ª–∞–¥–∏ —ñ—Ç–∞–ª—ñ–π—Å—å–∫–æ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫—â–æ –≤–æ–Ω–æ –±—É–ª–æ –ø–æ–≤–Ω—ñ—Å—Ç—é –Ω–∞–ø–∏—Å–∞–Ω–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é!
- –≤ —ñ–Ω—à–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!

::words::
- —è–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±—É–ª–æ –ø–æ–≤–Ω—ñ—Å—Ç—é —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!
- —Ñ–æ—Ä–º–∞—Ç –º–∞—î –±—É—Ç–∏ —Å—Ç—Ä–æ–≥–æ <—ñ—Ç–∞–ª—ñ–π—Å—å–∫–µ —Å–ª–æ–≤–æ> - <—É–∫—Ä–∞—ó–Ω—Å—å–∫–µ —Å–ª–æ–≤–æ> - –ù–ï –ù–ê–í–ü–ê–ö–ò!
- —è–∫—â–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, —Å—Ç–∞–ª–æ–º—É –≤–∏—Ä–∞–∑—ñ –∞–±–æ –ø–æ–≤ º—è–∑–∞–Ω–∏—Ö —Å–ª–æ–≤–∞—Ö ‚Äî –Ω–∞–¥–∞–π **–ø–æ–≤–Ω—É –ø—Ä–∞–≤–∏–ª—å–Ω—É —Ñ—Ä–∞–∑—É —Ç–∞–∫, —è–∫ –≤–æ–Ω–∞ –º–∞—î –≤–∏–≥–ª—è–¥–∞—Ç–∏ –≤ —Ä–µ—á–µ–Ω–Ω—ñ**. –ù–µ –æ–±—Ä—ñ–∑–∞–π –¥—ñ—î—Å–ª–æ–≤–∞, —á–∞—Å—Ç–∫–∏ –∞–±–æ –∞—Ä—Ç–∏–∫–ª—ñ.
- —Å—Ç–∞–≤ –æ–±–∏–¥–≤–∞ —Å–ª–æ–≤–∞ (—ñ —ñ—Ç–∞–ª—ñ–π—Å—å–∫–µ, —ñ —É–∫—Ä–∞—ó–Ω—Å—å–∫–µ) –≤ –±–∞–∑–æ–≤—ñ–π —Ñ–æ—Ä–º—ñ (—ñ–Ω—Ñ—ñ–Ω—ñ—Ç–∏–≤, –æ–¥–Ω–∏–Ω–∞, —á–æ–ª–æ–≤—ñ—á–∏–π —Ä—ñ–¥)!
- —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ –≤ –¥—ñ—î—Å–ª–æ–≤—ñ, –ø–æ—Å—Ç–∞–≤ –π–æ–≥–æ –≤ —ñ–Ω—Ñ—ñ–Ω—ñ—Ç–∏–≤—ñ;
- —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ –≤ –¥—ñ—î—Å–ª–æ–≤—ñ, —ñ –ø—ñ—Å–ª—è –¥—ñ—î—Å–ª–æ–≤–∞ —Å—Ç–æ—ó—Ç—å –ø—Ä–∏–π–º–µ–Ω–Ω–∏–∫, –¥–æ–¥–∞–π —Ü–µ–π –ø—Ä–∏–π–º–µ–Ω–Ω–∏–∫ –¥–æ –¥—ñ—î—Å–ª–æ–≤–∞. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: innamorarsi di - –∑–∞–∫–æ—Ö–∞—Ç–∏—Å—è –≤;
- —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ –≤ —ñ–º–µ–Ω–Ω–∏–∫—É, –ø–æ—Å—Ç–∞–≤ –π–æ–≥–æ –≤ –Ω–∞–∑–∏–≤–Ω–æ–º—É –≤—ñ–¥–º—ñ–Ω–∫—É –æ–¥–Ω–∏–Ω–∏;
- —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ –≤ –ø—Ä–∏–∫–º–µ—Ç–Ω–∏–∫—É, –ø–æ—Å—Ç–∞–≤ –π–æ–≥–æ –≤ —á–æ–ª–æ–≤—ñ—á–æ–º—É —Ä–æ–¥—ñ –æ–¥–Ω–∏–Ω–∏;
- —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –±—É–ª–∞ —Ç—ñ–ª—å–∫–∏ —É —Ñ–æ—Ä–º—ñ –¥—ñ—î—Å–ª–æ–≤–∞, –Ω–µ –¥–æ–¥–∞–≤–∞–π –π–æ–≥–æ –¥–æ —Å–ø–∏—Å–∫—É - –Ω–µ –º–∞—î —Å–µ–Ω—Å—É!
- –Ω–µ –¥–æ–¥–∞–≤–∞–π –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–∫–æ–≤–∏—Ö —Å–ª—ñ–≤ —á–∞—Å—Ç–∫–∏. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, "di - –≤" - –Ω–µ –º–∞—î —Å–µ–Ω—Å—É!
- –Ω–µ –¥–æ–¥–∞–≤–∞–π –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–∫–æ–≤–∏—Ö —Å–ª—ñ–≤ –¥—ñ—î—Å–ª–æ–≤–∞ essere, potere —ñ avere, –∞ —Ç–∞–∫–æ–∂ –ø—Ä–∏–π–º–µ–Ω–Ω–∏–∫–∏.
- –Ω–µ –¥–æ–¥–∞–≤–∞–π –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–∫–æ–≤–∏—Ö —Å–ª—ñ–≤ —Å–ª–æ–≤–∞, –≤ —è–∫–∏—Ö –Ω–µ –±—É–ª–æ –¥–æ–ø—É—â–µ–Ω–æ –ø–æ–º–∏–ª–∫–∏!
- üö´ –ù–µ –¥–æ–¥–∞–≤–∞–π —É —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–∫–æ–≤–∏—Ö —Å–ª—ñ–≤ —Ç—ñ, –¥–µ –∑–∞–º—ñ—Å—Ç—å –∞–∫—Ü–µ–Ω—Ç—ñ–≤ —Å—Ç–æ—ó—Ç—å '. –¶–µ –Ω–µ –ø–æ–º–∏–ª–∫–∞. –ù—ñ–∫–æ–ª–∏!!!
- —è–∫—â–æ —î–¥–∏–Ω–∞ –Ω–µ—Ç–æ—á–Ω—ñ—Å—Ç—å - —Ü–µ –ø—Ä–æ–ø—É—â–µ–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç –∞–±–æ –Ω–∞–≥–æ–ª–æ—Å, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!
- —è–∫—â–æ –Ω–µ–º–∞—î –ø–æ–º–∏–ª–∫–æ–≤–∏—Ö —Å–ª—ñ–≤, –Ω–µ –¥–æ–¥–∞–≤–∞–π —Ü–µ–π –±–ª–æ–∫ –≤–∑–∞–≥–∞–ª—ñ!
"""
